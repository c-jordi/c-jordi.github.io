!function(){"use strict";function t(t=[100,100],e=null){return Array(t[0]).fill(0).map(i=>Array.isArray(e)?Array(t[1]).fill(0).map(t=>e.slice()):isNaN(e)?Array(t[1]):Array(t[1]).fill(e))}function e(e,i,s=null){return Array(e).fill(0).map(e=>t(i,s))}Array.prototype.indexOfRand=function(t){let e=[],i=this;for(;i.indexOf(t)>-1;)e.push(i.indexOf(t)),i[i.indexOf(t)]=null;return e.length?e[Math.floor(Math.random()*e.length)]:-1};const i=()=>"xxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}));function s({alpha:t=1,beta:i=.2,k:s=.01,nodes:n={list:[{name:"node_1",state:1,coord:[15,1]},{name:"node_2",state:-1,coord:[29,1]}]},layout:{size:o=[30,30],lattice:h="square",position:a="discrete"},epsilon:r=.5,s0:l=25e3}){this.size=o,this.alpha=t,this.beta=i,this.k=s,this.epsilon=r,this.s0=l,this.framerate=30,this.position=a,this.hitBox=1,this.freeze=!1,this.lattice=h,this.timeSinceStart=0,this.fields={positive:e(5,this.size,0),negative:e(5,this.size,0)},this.fieldsDt={positive:e(5,this.size,0),negative:e(5,this.size,0)},this.fieldsDx={positive:e(5,this.size,[0,0]),negative:e(5,this.size,[0,0])},this.nodes=n,this.nodesCenter=void 0,this.nodeColor={positive:[246,255,51],negative:[51,255,240],default:[255,255,255]},this.allowedSteps=[[-1,0],[0,1],[1,0],[0,-1]],this.init()}function n(){this.list=[],this.addRandom=this.addRandom.bind(this)}s.prototype.getEmission=function(t){return this.s0*Math.exp(-this.beta*t*2/2)},s.prototype.setStartingState=function(t){return"rand"==t&&(t=Math.floor(2*Math.random())?"positive":"negative"),t},s.prototype.apply=function(t){["positive","negative"].forEach(e=>{for(let i=0;i<this.size[0];i++)for(let s=0;s<this.size[1];s++)t(e,i,s)})},s.prototype.setStartingPosition=function(t,e){return"rand"==t&&(t=Math.random()*this.size[0]),"rand"==e&&(e=Math.random()*this.size[1]),"continuous"===this.position?[t,e]:this.setPosition(t,e)},s.prototype.setPosition=function(t,e){return"square"==this.lattice?[Math.floor(t),Math.floor(e)]:this.lattice.includes("trian")?[t,e=t%2?4*Math.floor(e/4)+2:4*Math.floor(e/4)]:void 0},s.prototype.assignState=function(t){const[e,i]=this.setPosition(t.x,t.y);this.nodesCenter.positive.forEach(s=>{s[0]-this.hitBox<=e&&s[0]+this.hitBox>=e&&s[1]-this.hitBox<=i&&s[1]+this.hitBox>=i&&(t.state="positive",t.timeSinceCollision=0)}),this.nodesCenter.negative.forEach(s=>{s[0]-this.hitBox<=e&&s[0]+this.hitBox>=e&&s[1]-this.hitBox<=i&&s[1]+this.hitBox>=i&&(t.state="negative",t.timeSinceCollision=0)})},s.prototype.makeNodesCenter=function(){this.nodesCenter={positive:this.nodes.list.filter(t=>1===t.state).map(t=>t.coord),negative:this.nodes.list.filter(t=>-1===t.state).map(t=>t.coord)}},s.prototype.init=function(){this.makeNodesCenter()},s.prototype.reset=function(){this.resetFields(),this.resetFieldsDt(),this.resetFieldsDx()},s.prototype.clearFields=function(){this.fields={positive:e(5,this.size,0),negative:e(5,this.size,0)}},s.prototype.resetFields=function(){this.fields={positive:[this.fields.positive[0],...e(4,this.size,0)],negative:[this.fields.negative[0],...e(4,this.size,0)]}},s.prototype.resetFieldsDx=function(){this.fieldsDx={positive:e(5,this.size,[0,0]),negative:e(5,this.size,[0,0])}},s.prototype.resetFieldsDt=function(){this.fieldsDt={positive:e(5,this.size,0),negative:e(5,this.size,0)}},s.prototype.noiseStep=function(){const t=2*Math.random()*Math.PI,e=Math.sqrt(2*this.epsilon);return[e*Math.cos(t),e*Math.sin(t)]},s.prototype.discreteStep=function(t){if(t==[0,0])return[0,0];const e=this.allowedSteps.map(e=>e[0]*t[0]+e[1]*t[1]),i=Math.max(...e),s=e.indexOfRand(i);return this.allowedSteps[s]},s.prototype.clear=function(){this.clearFields(),this.resetFieldsDt(),this.resetFieldsDx(),this.makeNodesCenter(),this.timeSinceStart=0},n.prototype.default=function(){this.layoutId="Switch",this.add("node_1",1,[15,7]),this.add("node_2",-1,[15,22])},n.prototype.toggle=function(t){this.includes(t.name)?this.remove(t.name):this.add(t.name,t.state,t.coord)},n.prototype.includes=function(t){return this.list.map(t=>t.name).includes(t)},n.prototype.add=function(t,e,[i,s]){this.list.push({name:t,state:e,coord:[i,s]})},n.prototype.remove=function(t){void 0!==t&&(this.list=this.list.filter(e=>e.name!==t))},n.prototype.assign=function(t,e){void 0!==t&&(this.list=this.list.map(i=>({...i,...i.name===t?e:{}})))},n.prototype.addRandom=function(t,e){this.add("Node_"+this.list.length,2*Math.random()>1?1:-1,[Math.floor(Math.random()*t),Math.floor(Math.random()*e)])};function o(t,e){this.env=t,this.walkers=e,this.timeMap=[0]}function h(t,e,i="euler",s,n){this.running=!1,this.env=t,this.walkers=e,this.engine=i.toLowerCase(),this.database=s,this.analysis=n,this.setup(),this.counter=0}function a(t,e){return this.rows=t.length,this.cols=t[0].length,this.forest=t,this.campfires=e,this.maxPathLength=50,this.A=null,this.edges=[],this.connect()}function r(t,e,i){this.nodes=e,this.env=t,this.connectivityThreshold=2*t.s0,this.database=i,this.adjencyMatrix=null,this.hoshenKopelman=null,this.reset()}function l(e,s,n,o,h=[]){this.env=e,this.walkers=s,this.database=o,this.nodes=n,this.version=i(),this.sessions=[this.version],this.combinedField=t(this.env.size,0),this.maxima={max:1,min:0},this.maxMinThreshold=1e3,this.interval=10,this.events=[],this.displayOptions={showWalkers:!1,showNodes:!0,showCombinedFields:!0,showPositiveField:!1,showNegativeField:!1,defaultColor:"#ffffff",positiveColor:"#f6ff33",negativeColor:"#33fff0",combinedColor:"#6a0dad"},this.fineGrain=1,this.connectivity=new r(e,n,o)}function p(t,e){this.name=t,this.callback=e||function(){}}function d(t,e,i,s){this.minInt=0,this.maxFrames=1e4,this.id=t,this.frame=-1,this.callback=e,this.defaultCallback=i,this.start=this.start.bind(this),this.step=this.step.bind(this),this.request=t=>{s(window.requestAnimationFrame(t))}}function c({walkers:t,analysis:e,engine:i,env:s,nodes:n,worker:o=!1}){this.walkers=t,this.analysis=e,this.engine=i,this.nodes=n,this.env=s,this.loop=void 0,this.loopCallback=void 0,this.slowMo=!1,this.worker=o,this.updates={ui:0,game:0,back:0},this.setRequestId=this.setRequestId.bind(this),this.useCallback=this.useCallback.bind(this),this.useRedraw=this.useRedraw.bind(this),this.toggleEngine=this.toggleEngine.bind(this),this.setContrast=this.setContrast.bind(this),this.setParams=this.setParams.bind(this),this.setLayout=this.setLayout.bind(this)}function u(t,e,i,s){this.name=t,this.state=s,this.timeSinceCollision=0,this.x=e,this.y=i,this.dr=Array(4).fill(null),this.pathColor=[255,255,255]}function f(t,e,i,s,n){this.numberOfAgents=t,this.state=n,this.env=e,this.x=i,this.y=s,this.squad=[],this.createSquad()}o.prototype.run=function(){this.computeFieldsDx(0,0),this.computeFieldsDt(0,0),this.computeWalkersDr(0,0),this.computeEulerFields(),this.computeEulerWalkers(),this.env.timeSinceStart++},o.prototype.computeEulerFields=function(){this.env.apply((t,e,i)=>{this.env.fields[t][0][e][i]=this.env.fields[t][0][e][i]+this.env.fieldsDt[t][0][e][i]})},o.prototype.getPosition=function(){},o.prototype.computeEulerWalkers=function(){this.walkers.apply(t=>{t.timeSinceCollision+=1,t.x=(t.x+t.dr[0][0]+this.env.size[0])%this.env.size[0],t.y=(t.y+t.dr[0][1]+this.env.size[1])%this.env.size[1],this.env.assignState(t)})},o.prototype.computeWalkersDr=function(t,e){this.walkers.apply(i=>{const[s,n,o]=[i.state,i.x,i.y],h=((e,i,s)=>{if(0==e)return[0,0];const n="negative"==e?"positive":"negative",[o,h]=this.env.setPosition(i,s);return this.env.fieldsDx[n][t][o][h].map(t=>t*this.env.alpha)})(s,n,o),a=this.env.noiseStep();if("discrete"==this.env.position){const t=this.env.discreteStep([h[0]+a[0],h[1]+a[1]]);i.dr[e]=t}else i.dr[e]=[h[0]+a[0],h[1]+a[1]];const r=(l=h,p=a,Math.sqrt(l[0]**2+l[1]**2)/Math.sqrt(p[0]**2+p[1]**2));var l,p;i.pathColor=r<1?[255,255,255]:r>1&&r<2?[255,...[255,255].map(t=>t*(2-r))]:[255,0,0]})},o.prototype.computeFieldsDt=function(t,e){this.addResidues(t,e),this.addEmissions(t,e)},o.prototype.addResidues=function(t,e){this.env.apply((i,s,n)=>{this.env.fieldsDt[i][e][s][n]=-this.env.k*this.env.fields[i][t][s][n]})},o.prototype.addEmissions=function(t,e){this.walkers.apply(i=>{const[s,n,o,h]=[i.state,i.x,i.y,i.timeSinceCollision],[a,r]=this.env.setPosition(n,o);if("positive"!=s&&"negative"!=s)return;const l=h+this.timeMap[t];this.env.fieldsDt[s][e][a][r]+=this.env.getEmission(2*l)})},o.prototype.computeFieldsDx=function(t,e){this.env.apply((i,s,n)=>{const o=(s-1+this.env.size[0])%this.env.size[0],h=(s+1+this.env.size[0])%this.env.size[0];this.env.fields[i][t][h][n]||(this.env.fields[i][t][h][n]=0),this.env.fields[i][t][o][n]||(this.env.fields[i][t][o][n]=0),this.env.fieldsDx[i][e][s][n][0]=(this.env.fields[i][t][h][n]-this.env.fields[i][t][o][n])/2;const a=(n-1+this.env.size[1])%this.env.size[1],r=(n+1+this.env.size[1])%this.env.size[1];this.env.fields[i][t][s][r]||(this.env.fields[i][t][s][r]=0),this.env.fields[i][t][s][a]||(this.env.fields[i][t][s][a]=0),this.env.fieldsDx[i][e][s][n][1]=(this.env.fields[i][t][s][r]-this.env.fields[i][t][s][a])/2})},h.prototype.restart=function(){this.env.clear(),this.walkers.reset(),this.counter=0},h.prototype.setup=function(){switch(this.engine){case"euler":this.engine=new o(this.env,this.walkers);break;default:console.log("No engine was selected...")}},h.prototype.next=function(){this.running&&(this.env.init(),this.counter++,this.engine.run(),this.saveMetrics(),this.env.reset(),this.walkers.resetDr())},h.prototype.toggle=function(){this.running=!this.running},h.prototype.stop=function(){this.running=!1},h.prototype.saveMetrics=function(){},a.prototype.connect=function(){return this.A=this.campfires.map(t=>this.burnForest(t)),this.A},a.prototype.burnForest=function(t){const{name:e,state:i,coord:s}=t;let n=(o=this.forest,JSON.parse(JSON.stringify(o)));var o;let h=[[...s,-1]];for(;h.length&&h[0][2]<this.maxPathLength;)this.explore(n,h);return this.campfires.map(e=>{const[i,s]=e.coord;return this.getNeighbors(i,s,1).filter(([i,s])=>n[i][s]>1&&e.name!=t.name).length?1:0})},a.prototype.explore=function(t,e){const[i,s,n]=e.shift();if((0!=t[i][s]||-1===n)&&(t[i][s]=n,!this.checkCampfire([i,s])||-1===n||2===n))if(-1==n){this.getNeighbors(i,s,1).forEach(i=>{const[s,n]=i;1==t[s][n]&&e.push([s,n,2])})}else{this.getNeighbors(i,s).forEach(i=>{const[s,o]=i;1==t[s][o]&&e.push([s,o,n+1])})}},a.prototype.checkCampfire=function(t){return this.campfires.filter(e=>(this.getNeighbors(e.coord,1).filter(e=>e[0]==t[0]&&e[1]==t[1]),e.coord[0]-1<=t[0]&&t[0]<=e.coord[0]+1&&e.coord[1]-1<=t[1]&&e.coord[1]+1>=t[1])).length},a.prototype.getNeighbors=function(t,e,i=0){const s=(e-1+this.cols)%this.cols,n=(t-1+this.rows)%this.rows,o=(t+1+this.rows)%this.rows,h=(e+1+this.cols)%this.cols;return i?[[t,h],[t,s],[n,e],[o,e],...[[n,s],[n,h],[o,s],[o,h]]]:[[t,h],[t,s],[n,e],[o,e]]},r.prototype.filterUsingThreshold=function(t){for(let e=0;e<this.env.size[0];e++)for(let i=0;i<this.env.size[1];i++)this.filteredField[e][i]=t[e][i]>this.connectivityThreshold?1:0},r.prototype.reset=function(){this.filteredField=t(this.env.size,0)},r.prototype.run=function(t,{time:e,version:i}){this.reset(),this.filterUsingThreshold(t);const s=new a(this.filteredField,this.nodes.list),n=s.map(t=>t.reduce((t,e)=>t+e,0)).reduce((t,e)=>t+e,0);return this.database.push("connectivity",{time:e,A:s,version:i,E:n/2}),{time:e,y:n/2}},l.prototype.combineFields=function(){let e=t(this.env.size,0);for(var i=0;i<this.env.size[0];i++)for(let t=0;t<this.env.size[1];t++)e[i][t]=this.env.fields.positive[0][i][t]+this.env.fields.negative[0][i][t];this.combinedField=e},l.prototype.computeMaxima=function(){this.maxima.min=Math.min(...this.combinedField.flat()),this.maxima.max=Math.max(...this.combinedField.flat()),this.maxima.max=this.maxima.max<this.maxMinThreshold?this.maxMinThreshold:this.maxima.max},l.prototype.run=function(){this.combineFields(),this.computeMaxima(),this.checkEvents()},l.prototype.checkEvents=function(){this.env.timeSinceStart%this.interval==0&&this.edge(),this.events.forEach(t=>{this.env.timeSinceStart===t.t&&this.applyEvent(t)})},l.prototype.applyEvent=function(t){switch(t.type){case"node":this.nodes.toggle(t);break;case"parameter":this.env[t.name]=+t.value}},l.prototype.edge=function(){this.connectivity.run(this.combinedField,{time:this.env.timeSinceStart,version:this.version})},l.prototype.clear=function(){this.version=i(),this.sessions.push(this.version),this.combinedField=t(this.env.size,0)},p.prototype.push=function(t,e){void 0===this[t]&&(this[t]=[]),this.callback({name:t,value:e}),this[t].push(e)},p.prototype.save=function(t,e){void 0===this["_"+t]&&(this["_"+t]={});const i=Math.round(e);i in this["_"+t]?this["_"+t][i]++:this["_"+t][i]=1},d.prototype.start=function(){this.startTime=performance.now(),this.request(this.step)},d.prototype.step=function(){performance.now()-this.startTime>this.minInt?(this.frame++,this.callback({id:this.id,frame:this.frame}),this.startTime=performance.now()):this.defaultCallback(),this.request(this.step)},d.prototype.slowMo=function(t){this.minInt=t?400:0},c.prototype.getEnv=function(t){const{size:e,alpha:i,beta:s,k:n,epsilon:o,s0:h}=this.env,{numberOfAgents:a}=this.walkers;return JSON.parse(JSON.stringify({size:e,numberOfAgents:a,alpha:i,beta:s,k:n,epsilon:o,s0:h}))},c.prototype.setEnv=function({size:t,numberOfAgents:e,alpha:i,beta:s,k:n,epsilon:o,s0:h},a){this.env.alpha=+i,this.env.beta=+s,this.env.k=+n,this.env.epsilon=+o,this.env.s0=+h,this.walkers.setPopulation(+e),a&&(this.env.size=t,this.engine.restart())},c.prototype.getLayers=function(){const{showWalkers:t,showNodes:e,showCombinedFields:i,showPositiveField:s,showNegativeField:n,positiveColor:o,negativeColor:h,defaultColor:a,combinedColor:r}=this.analysis.displayOptions;return{showWalkers:t,showNodes:e,showCombinedFields:i,showPositiveField:s,showNegativeField:n,positiveColor:o,negativeColor:h,defaultColor:a,combinedColor:r,slowMo:(l=this.slowMo,JSON.parse(JSON.stringify(l)))};var l},c.prototype.setLayers=function(t,e){switch(t){case"slowMo":this.useSlowMo(e);break;default:return void(this.analysis.displayOptions[t]=e)}},c.prototype.setContrast=function(t){this.analysis.fineGrain=t},c.prototype.setLayout=function(t,e,i=[],s=[],n){this.nodes.list=t,this.nodes.layoutId=n,this.env.makeNodesCenter(),this.setParams(i),this.setEvents(s),this.env.size[0]===e[0]&&this.env.size[1]===e[1]||(this.env.size=e,this.engine.restart(),this.analysis.clear()),this.useRedraw()},c.prototype.setDefaultParams=function(){this.worker||(this.useSlowMo(!1),this.analysis.displayOptions.showWalkers=!1)},c.prototype.setParams=function(t){this.setDefaultParams(),Array.isArray(t)&&t.forEach(t=>{switch(t.name){case"numberOfAgents":this.walkers.setPopulation(+t.value);break;case"showWalkers":case"showCombinedField":case"showPositiveField":case"showNegativeField":this.analysis.displayOptions[t.name]=t.value;break;case"slowMo":this.useSlowMo(+t.value)}})},c.prototype.setEvents=function(t){this.analysis.events=t},c.prototype.setRequestId=function(t){this.reqId=t},c.prototype.useCallback=function(t){this.loopCallback(t)},c.prototype.useRedraw=function(){this.redraw&&this.redraw()},c.prototype.setRequestId=function(t){this.reqId=t},c.prototype.setupLoop=function(t,e){this.loopCallback=e,this.loop instanceof d||(this.loop=new d(t,this.useCallback,this.useRedraw,this.setRequestId))},c.prototype.setupRedraw=function(t){this.redraw=t},c.prototype.stopLoop=function(){this.loop instanceof d&&(window.cancelAnimationFrame(this.reqId),this.reqId=void 0)},c.prototype.startLoop=function(){this.loop instanceof d&&void 0===this.reqId&&this.loop.start()},c.prototype.useSlowMo=function(t){this.slowMo=void 0===t?!this.slowMo:t,this.stopLoop(),this.loop.slowMo(this.slowMo),this.startLoop()},c.prototype.toggleEngine=function(t){this.engine.running=void 0===t?!this.engine.running:t},c.prototype.setPopulation=function(t){this.walkers.setPopulation(t)},f.prototype.createSquad=function(){for(let t=0;t<this.numberOfAgents;t++)this.squad.push(this.createWalker("Walker_"+t))},f.prototype.createWalker=function(t){const[e,i]=this.env.setStartingPosition(this.x,this.y);return new u(t,e,i,this.env.setStartingState(this.state))},f.prototype.removeWalker=function(t=1){if(0!==t){if(this.squad.length){const e=this.squad.length<t?this.squad.length:t;this.squad=this.squad.slice(0,-e)}this.numberOfAgents=this.squad.length}},f.prototype.addWalker=function(t=1){for(let e=0;e<t;e++)this.squad.push(this.createWalker("Walker_"+(this.squad.length+e)));this.numberOfAgents=this.squad.length},f.prototype.setPopulation=function(t){if(!Number.isInteger(t))return;const e=t-this.numberOfAgents;e>0?this.addWalker(e):this.removeWalker(-e)},f.prototype.resetPath=function(){for(let t=0;t<this.numberOfAgents;t++)this.squad[t].xpath=[this.squad[t].x,...Array(4).fill(0)],this.squad[t].ypath=[this.squad[t].y,...Array(4).fill(0)]},f.prototype.apply=function(t){for(let e=0;e<this.numberOfAgents;e++)t(this.squad[e])},f.prototype.resetDr=function(){for(let t=0;t<this.numberOfAgents;t++)this.squad[t].dr=Array(4).fill(null)},f.prototype.reset=function(){this.squad=[],this.createSquad()};[0,1,2,3,4].map(t=>[0,1,2,3,4].map(e=>[20*t,20*e])).flat().map((t,e)=>[{name:"node_p"+e,state:1,coord:t},{name:"node_n"+e,state:-1,coord:[t[0]+10,t[1]+10]}]).flat();function v(t){const{alpha:e,beta:i,k:s,epsilon:n,s0:o}=t;return{alpha:e,beta:i,k:s,epsilon:n,s0:o,layout:{}}}function m(t){"connectivity"===t.name&&self.postMessage({fn:"update",data:[t.value.time,t.value.E,t.value.version,t.value.A].flat()})}self.addEventListener("message",(function(t){var e=t.data;switch(e.fn){case"start":!function(t){const{frames:e,runs:i,query:o,preset:a}=t,r=new n;r.default();const d=new s({alpha:1,k:.03,beta:.2,epsilon:.5,s0:1e4,framerate:1,layout:{},nodes:r,...v(o)}),u=new f(o.numberOfAgents,d,"rand","rand",0),y=new p("Walker Api Metrics",m),g=new l(d,u,r,y),w=new h(d,u,"euler",y,g),b=new c({walkers:u,analysis:g,engine:w,env:d,nodes:r,worker:!0});b.setLayout(a.nodes,a.size,[],a.events,a.name),function(t,e,i){t.toggleEngine(!0);for(let s=0;s<i;s++){for(let i=0;i<e;i++)t.engine.next(),t.analysis.run();t.engine.restart(),t.analysis.clear()}}(b,e,i),self.postMessage({fn:"done"})}(e);break;default:self.postMessage("Unknown command: "+e.msg)}}),!1)}();
//# sourceMappingURL=worker.js.map
